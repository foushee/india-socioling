---
title: "India Sociolinguistics Wealth Associations Analyses"
author: "Ruthe Foushee"
date: "2023-08-18"
output:
  html_document:
    df_print: paged
---

```{r wealth-setup, include=FALSE}
library(here)
here::i_am('1_speaker-associations/1c_wealth.Rmd')

knitr::opts_chunk$set(
  echo = FALSE, message=F, warning=F,
  fig.width = 6)

source(here('isl-resources.R'))
```

```{r read-in-data}
a <- read.csv(here('data/r_dfs/associations_data.csv'))[,-1]

factor_vars <- c('study_name', 'id', 'child_sex', 'child_religion', 
                 'school', 'standard',
                 'question_type', 'language', 'speaker_gender', 
                 'origin', 'geographic_origin', 'religion', 'wealth',
                 'army_navy_language')

numeric_vars <- c('standard_num', 'child_age', 'child_age_centered', 
                  'sequence', 'coded_wealth')

a <- a %>%
  mutate_at(factor_vars, as.factor) %>%
  mutate_at(numeric_vars, as.numeric)

w <- a %>%
  filter(wealth!="")
```

```{r wealth-no-opinion-trials}
N_TRIALS <- w %>%
  filter(no_opinion_wealth==1) %>%
  summarize(no_opinion_trials=n()) %>%
  as.numeric()

N_CHILDREN <- w %>%
  filter(no_opinion_wealth==1) %>%
  group_by(id) %>%
  summarize(no_opinion_trials=n()) %>%
  summarize(n_children=n()) %>%
  as.numeric()
  
w %>%
  filter(no_opinion_wealth==1) %>%
  group_by(id)%>%
  summarize(no_opinion_trials=n()) %>%
  group_by(no_opinion_trials) %>%
  summarize(n_children=n()) %>%
  kable(.)

w %>%
  filter(no_opinion_wealth==1) %>%
  group_by(language)%>%
  summarize(n=n()) %>%
  arrange(desc(n)) %>%
  kable(.)

#265 opted out, 61 children, most on chinese and marathi
```

"No opinion" selected on `r N_TRIALS` trials by `r N_CHILDREN` children; all children selected single response.

```{r wealth-single-trials}
table(w$wealth)
```

## Analyzed Categorically: "Less $"/"As Much $"/"More $"

```{r wealth-overall-barplot, include=F}
wealth_summary_tab <- w %>%
  ungroup(.) %>%
  dplyr::select("language", all_of(wealth_vars)) %>%
  gather(., wealth, selection, -language) %>%
    group_by(language, wealth) %>%
    summarize(mean=na.mean(selection),
              cilo = mean-ci.low(selection),
              cihi = mean+ci.high(selection)) 

wealth_summary_tab$wealth <- factor(
  wealth_summary_tab$wealth, 
  levels=wealth_vars, 
  labels=wealth_labels)

ggplot(wealth_summary_tab, 
       aes(x=wealth, y=mean, fill=wealth)) +
    geom_bar(stat="identity") + 
    geom_errorbar(aes(ymin=cilo, ymax=cihi), width=0, 
                  color=line_color) + 
    facet_wrap(~language, ncol=2) +
    scale_fill_manual(values = wealth_colors,
                      wealth_legend_title1) +
    ylim(0, 1) +
    sans_theme +
    theme(legend.title = element_text(
      size=10, colour="gray30", family="sans", face="italic")) +
    ylab("Mean")

ggsave("wealth_associations.png", device = "png", 
       path = "plots/",
       scale = 1, width = 7, height = 6, units = "in")
```

### Over Time

#### By Standard

```{r wealth-std-lineplot}
wealth_std_summary_tab <- w %>%
  ungroup(.) %>%
  dplyr::select("language", "standard", "standard_num",
    all_of(wealth_vars)) %>%
  gather(., wealth, selection, -language, -standard, -standard_num) %>%
    group_by(language, standard, standard_num, wealth) %>%
    summarize(mean=na.mean(selection),
              cilo = mean-ci.low(selection),
              cihi = mean+ci.high(selection)) 

wealth_std_summary_tab$wealth <- factor(
  wealth_std_summary_tab$wealth, 
  levels=wealth_vars, 
  labels=wealth_labels)

ggplot(wealth_std_summary_tab, 
       aes(x=standard_num, y=mean, color=wealth)) +
    geom_line(aes(lty=wealth)) + 
    geom_point(aes(shape=wealth)) +
    geom_errorbar(aes(ymin=cilo, ymax=cihi), width=0) +
    facet_wrap(~language, ncol=4) +
    scale_color_manual(values=wealth_colors, wealth_legend_title) + 
    scale_shape_manual(values=wealth_shapes, wealth_legend_title) +
    scale_linetype_manual(values=wealth_ltys,
                          wealth_legend_title) +
    ylim(0, 1) +
    scale_x_continuous(breaks=c(1, 2, 3), 
                       label=std_axis_labels) +
   # labs(title="wealth Associations Across Standards 3-7") +
    sans_axes_theme +
    theme(legend.position = "bottom") +
    xlab("Grade") +
    ylab("Mean")
  
ggsave("wealth_std.png", device = "png", 
       path = "plots/final/",
       scale = 1, width = 7, height = 5, units = "in")
```

```{r wealth-std-barplot, include=F}

ggplot(wealth_std_summary_tab, 
       aes(x=wealth, y=mean, fill=wealth)) +
    geom_bar(stat="identity") + 
    geom_errorbar(aes(ymin=cilo, ymax=cihi), width=0, 
                  color=line_color) + 
    facet_wrap(~language + standard, ncol=3) +
    scale_fill_manual(values = wealth_colors, wealth_legend_title1) +
    ylim(0, 1) +
    xlab("Standard") +
    ylab("Mean") +
    sans_axes_theme +
    theme(legend.title = element_text(
      size=10, colour="gray30", family="sans", face="italic"))

ggsave("plots/wealth_std_barplot.png", height=16, width=14, units="in")
```

### With Age. 

```{r wealth-age, include=F}
wealth_age_df <- w %>%
  ungroup(.) %>%
  dplyr::select(
    "language", "child_age", all_of(wealth_vars)) %>%
  gather(., wealth, selection, -language, -child_age) 

wealth_age_df$wealth <- factor(wealth_age_df$wealth, 
      levels=wealth_vars, labels=wealth_labels)

ggplot(wealth_age_df, 
       aes(x=child_age, y=selection, color=wealth, lty=wealth, fill=wealth)) +
    stat_smooth(aes(x=child_age, y=selection), 
                method="lm", level=.75, fullrange=T) +
    facet_wrap(~language, ncol=4) +
    scale_color_manual(values = wealth_colors, wealth_legend_title1) +
    scale_linetype_manual(values=wealth_ltys, wealth_legend_title1) +
    scale_fill_manual(values=wealth_colors, wealth_legend_title1) +
    ylim(0, 1) +
    ylab("Mean") +
    xlab("Child Age (yrs)") +
    #labs(title="wealth Associations with Age") +
    sans_axes_theme +
    theme(legend.title = element_text(
      size=10, colour="gray30", family="sans", face="italic"))

ggsave("wealth_age_lm.png", device = "png", 
       path = "plots/",
       scale = 1, width = 7, height = 6, units = "in")
```

## Analyzed as a Continuous Variable 

Recoded responses to prompt "This speaker has...": 

* -1: "*Less* money than the people in my city" 

* 0: "*As much* money as the people in my city" 

* 1: "*More* money than the people in my city"

* NA: "No Opinion"

```{r recoded-wealth-df}
coded_wealth_df <- w %>% filter(!is.na(coded_wealth)) %>%
  group_by(language) %>%
  mutate(mean_wealth = na.mean(coded_wealth))

coded_wealth_df <- coded_wealth_df %>%
  filter(!is.na(language))
```

```{r recoded-wealth-boxplots-gradient, include=F}
ggplot(coded_wealth_df, 
       aes(x=language, y=coded_wealth)) +
    geom_boxplot(aes(fill=mean_wealth)) +
    scale_fill_gradient(low="#56614a", 
                        high="#a5d48f", 
                        name="Mean") +
    ylim(-1.1, 1.1) +
    #labs(title="Relative Wealth Associations by Language") +
    ylab("Comparative Wealth") + 
    xlab("") +
    sans_axes_theme +
  theme(axis.text.x=element_text(angle=60, hjust=1))

ggsave("wealth_recoded_boxplots.png", device = "png", 
       path = "plots/",
       scale = 1, width = 8, height = 8, units = "in")
```

```{r recoded-wealth-boxplots-colored}
coded_wealth_df %>%
  group_by(language) %>%
  summarize(relative_wealth = na.mean(coded_wealth))

coded_wealth_summary_df <- coded_wealth_df %>%
  group_by(language, standard, id) %>%
  summarize(relative_wealth = na.mean(coded_wealth))

ggplot(coded_wealth_summary_df, 
       aes(x=language, y=relative_wealth)) +
    geom_boxplot(aes(fill=language, color=language), alpha=0.5) +
    geom_hline(yintercept=0, lty=2, linewidth=1, colour=line_color) +
    scale_fill_manual(values=language_colors, name="Language") +
    scale_color_manual(values=language_colors, name="Language") +
    #ylim(-1, 1) +
    labs(title='Relative Wealth Associations by Language\n(0="As much money as the people in my city")') +
    ylab("Comparative Wealth") + 
    xlab("Language") +
    sans_axes_theme +
  theme(axis.text.x=element_text(angle=60, hjust=1),
        legend.position = "none")

ggsave("wealth_recoded_meaned_boxplots.png", device = "png", 
       path = "plots/",
       scale = 1, width = 7, height = 6, units = "in")
```

```{r recoded-wealth-barplots-colored}
coded_wealth_summary_df %>%
  group_by(language)%>%
  summarize(mean = mean(relative_wealth),
            cilo = mean - ci.low(relative_wealth),
            cihi = mean + ci.high(relative_wealth)) %>%
ggplot(., 
       aes(x=language, y=mean)) +
    geom_bar(stat="identity", aes(fill=language), alpha=0.9) +
    geom_hline(yintercept=0, lty=2, linewidth=1, colour=line_color) +
    scale_fill_manual(values=language_colors, name="Language") +
    geom_errorbar(aes(ymin=cilo, ymax=cihi), width=0, color=line_color) +
    scale_color_manual(values=language_colors, name="Language") +
    ylim(-1, 1) +
    labs(title='Relative Wealth Associations by Language\n(0="As much money as the people in my city"') +
    ylab("Comparative Wealth") + 
    xlab("Language") +
    sans_axes_theme +
  theme(axis.text.x=element_text(angle=60, hjust=1),
        legend.position = "none")

ggsave("wealth_recoded_meaned_barplots.png", device = "png", 
       path = "plots/",
       scale = 1, width = 7, height = 6, units = "in")
```

### With Age  

```{r recoded-wealth-age}
ggplot(coded_wealth_df, 
       aes(x=child_age, y=coded_wealth)) +
    geom_segment(aes(y=0, yend=0, x=7.2, xend=13), lty=2, colour="grey") +
    stat_smooth(aes(x=child_age, y=coded_wealth, 
                    color=language, fill=language),
                method="lm", level=.75, fullrange=T) +
    scale_color_manual(values=language_colors, name="Language") +
    scale_fill_manual(values=language_colors, name="Language") +
    facet_wrap(~language, ncol=4) +
    ylim(-1, 1) +
    #labs(title='Speaker Comparative Wealth Associations with Age\n(0="As much money as the people in my city"') +
    ylab("Comparative Wealth") + 
    xlab("Child Age (years)") +
    sans_axes_theme +
  theme(legend.position = "none")

ggsave("wealth_recoded_age_lm.png", device = "png", 
       path = "plots/",
       scale = 1.5, width = 6, height = 4, units = "in")
```

## Models: Relative Wealth as a Continuous Variable

```{r recoded-wealth-lmer}
wealth_lmer <- lmer(coded_wealth ~ language + 
                      child_age_centered + (1|id), w)

cbind(fixef(wealth_lmer), confint(wealth_lmer)[3:11,]) %>%
  kable(., caption="Wealth Model Fixed Effects")
```

```{r recoded-wealth-int-lmer}
wealth_int_lmer <- lmer(
  coded_wealth ~ language*child_age_centered + (1|id),
                    w)

cbind(fixef(wealth_int_lmer), confint(wealth_int_lmer)[3:18,]) %>%
  kable(., caption="Wealth Interaction Model Fixed Effects")

anova(wealth_lmer, wealth_int_lmer)

Anova(wealth_int_lmer)

wealth_int_lm <- lm(
  coded_wealth ~ language*child_age_centered,
                    w)
```

The interaction between language and child age is not significant in predicting children's speaker--wealth associations.

```{r recoded-wealth-id-int-lmer}
i <- read.csv(here('data/language_identification_correct.csv'))

wi <- merge(w, i, by=c("language", "id"))

wealth_id_lmer <- lmer(
  coded_wealth ~ language*id_correct + child_age_centered + (1|id),
                    wi)

cbind(fixef(wealth_id_lmer), confint(wealth_id_lmer)[3:19,]) %>%
  kable(., caption="Wealth-ID Interaction + Age Model Fixed Effects")

#anova(wealth_id_lmer, wealth_int_lmer)

Anova(wealth_id_lmer)
```


```{r recoded-wealth-ida-int-lmer}
wealth_idint_lmer <- lmer(
  coded_wealth ~ language*id_correct*child_age_centered + (1|id),
                    wi)

cbind(fixef(wealth_idint_lmer), confint(wealth_idint_lmer)[3:34,]) %>%
  kable(., caption="Wealth Interaction Model Fixed Effects")

#anova(wealth_id_lmer, wealth_idint_lmer)

Anova(wealth_idint_lmer)
```
